// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  var actionFormSelector, appendActionValue, container, iframe, initPlugin, loadMessages, messages, partialSelector, patchUploadForm, section, setMessage, submitAction, uploadButton, uploadDone, uploadForm, uploadFormId, uploadStart;
  partialSelector = ".svm";
  actionFormSelector = ".overlay-version form";
  uploadFormId = "#overlay-upload";
  container = $("#dashboard-svm-panel");
  section = container.parents('.o-collapsible-section');
  messages = {
    'uploading': null
  };
  iframe = null;
  uploadForm = null;
  uploadButton = null;
  setMessage = function(msg) {
    container.find('.messages').remove();
    container.prepend(msg);
    return section.trigger('remax');
  };
  uploadStart = function(e) {
    iframe.on('load', uploadDone);
    uploadButton.prop('disabled', true);
    setMessage(messages.uploading);
  };
  uploadDone = function(e) {
    var partial;
    partial = iframe.contents().find(partialSelector);
    container.html(partial);
    section.trigger('remax');
    return initPlugin();
  };
  loadMessages = function() {
    var msgId, results;
    results = [];
    for (msgId in messages) {
      if (messages[msgId] === null) {
        $("#" + msgId).loadTemplate();
        results.push(messages[msgId] = templates[msgId]);
      } else {
        results.push(void 0);
      }
    }
    return results;
  };
  appendActionValue = function(form) {
    var action, button;
    button = form.find('button');
    action = $('<input>', {
      type: 'hidden',
      name: 'action',
      value: button.attr('value')
    });
    return form.append(action);
  };
  patchUploadForm = function() {
    iframe = container.find('iframe');
    uploadForm = container.find(uploadFormId);
    uploadForm.on('submit', uploadStart);
    uploadForm.prop('target', iframe.prop('name'));
    return appendActionValue(uploadForm);
  };
  submitAction = function(e) {
    var form, res, url;
    e.preventDefault();
    form = $(this);
    appendActionValue(form);
    url = form.attr('action');
    res = $.post(url, form.serialize());
    res.done(function(data) {
      container.html(data);
      return initPlugin();
    });
    return res.fail(function() {
      setMessage(templates.dashboardPluginError);
    });
  };
  initPlugin = function(e) {
    var forms;
    loadMessages();
    patchUploadForm();
    forms = container.find(actionFormSelector);
    return forms.on('submit', submitAction);
  };
  return section.on('dashboard-plugin-loaded', initPlugin);
})(this, this.jQuery, this.templates);
